<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Encoding and Decoding</title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.5/lib/alea.min.js"></script>
</head>
<body>
    <h1>Ashleyan Indecipherable Code Translator</h1>

    <label for="text">Enter Text:</label>
    <input type="text" id="text" placeholder="Text to encode/decode" size="50"><br>

    <label for="passphrase">Enter Passphrase:</label>
    <input type="text" id="passphrase" placeholder="Passphrase for encoding/decoding"><br>

    <button onclick="encodeText()">Encode</button>
    <button onclick="decodeText()">Decode</button><br><br>

    <label for="output">Result:</label><br>
    <textarea id="output" rows="5" cols="50"></textarea>
    
    <script>
        // Define a map to store the n-grams and their corresponding capital letters
const nGramMap = {
    "sud": "A",
    "ash": "B",
    "the": "C",
    "and": "D",
    "tha": "E",
    "ent": "F",
    "ing": "G",
    "ion": "H",
    "tio": "I",
    "has": "J",
    "was": "K",
    "th": "L",
    "in": "M",
    "en": "N",
    "nt": "O",
    "ru": "P",
    "an": "Q",
    "am": "R",
    "is": "S",
    "it": "T",
    "de": "U",
    "te": "V",
    "ar": "W",
    "en": "X",
    "ed": "Y",
    "on": "Z",
};

function shuffleText(inputText, seed) {
    // Set random seed
    var rng = new alea(seed);

    // Reversible character shuffler
    let charTable = [];
    let numTable = [];
    let shuffleTable = [];
    let resultTable = [];

    // Create tables
    for (let i = 0; i < inputText.length; i++) {
        charTable.push(inputText.charAt(i));
        numTable.push(charTable.length);
        shuffleTable.push(0);
    }

    // Shuffle the numbers in numTable
    for (let i = 0; i < numTable.length; i++) {
        let currentNum = numTable[i];

        if (shuffleTable[i] === 0) {
            let newPos;
            do {
                newPos = Math.floor(rng() * numTable.length);
            } while (shuffleTable[newPos] !== 0);

            shuffleTable[i] = numTable[newPos];
            shuffleTable[newPos] = currentNum;
        }
    }

    // Reconstruct the shuffled text
    for (let i = 0; i < shuffleTable.length; i++) {
        let charIndex = shuffleTable[i] - 1;
        let char = charTable[charIndex];
        resultTable.push(char);
    }

    // Convert the result table into a string
    let resultText = resultTable.join("");

    return resultText;
}

function compressText(text) {
  text = text.toLowerCase()
  // Define the map of n-grams and their corresponding capital letters
  // Create a regular expression to match the n-grams
  const nGramRegex = new RegExp(Object.keys(nGramMap).join("|"), "g");

  // Replace the matched n-grams with their corresponding capital letters
  const compressedText = text.replace(nGramRegex, match => nGramMap[match]);

  return compressedText;
}

function decompressText(compressedText) {
  // Create a reverse map of capital letters to n-grams
  const reverseMap = {};
  for (const ngram in nGramMap) {
    const capitalLetter = nGramMap[ngram];
    reverseMap[capitalLetter] = ngram;
  }

  // Create a regular expression to match capital letters
  const capitalLetterRegex = /[A-Z]/g;

  // Replace the matched capital letters with their corresponding n-grams
  const originalText = compressedText.replace(capitalLetterRegex, match => reverseMap[match]);

  return originalText;
}

function createSalt() {
  var rngesus = new alea(Date.now())
  const characters = 'abcdefghijklmnopqrstuvwxyz ';
  let salt = '';

  for (let i = 0; i < 10; i++) {
    const randomIndex = Math.floor(rngesus() * characters.length);
    salt += characters.charAt(randomIndex);
  }

  return salt;
}

function salt(inputString) {
    const salt = createSalt();
    let saltedString = "";
    inputString = shuffleText(inputString, salt);
    saltedString = (inputString += salt);
    
    return saltedString;
}

function deSalt(inputString) {
    const salt = inputString.slice(-10);
    const string = inputString.slice(0, -10);
    
    let desaltedText = shuffleText(string, salt);
    
    return desaltedText;
}

function base27Encode(inputString) {
  // Define the characters for mapping
  const charMap = "wdbausrhylet ozknqgmfcixvpj";
  
  // Convert the input string to an array of ASCII values
  const asciiValues = [...inputString].map(char => char.charCodeAt(0));
  
  // Initialize an empty array to store the trinary digits
  const trinaryDigits = [];
  
  // Convert each ASCII value to trinary and concatenate
  for (const value of asciiValues) {
    let trinary = value.toString(3);
    trinary = trinary.padStart(5, '0');
    trinaryDigits.push(trinary);
  }
  
  // Concatenate all trinary digits and add extra 0s
  const concatenatedTrinary = trinaryDigits.join('') + '0'.repeat(trinaryDigits.length % 3);
  
  // Break down into groups of 3 and convert to integers
  const integerGroups = concatenatedTrinary.match(/.{3}/g).map(group => parseInt(group, 3));
  
  // Map integers to characters and concatenate
  const encodedString = integerGroups.map(integer => charMap[integer]).join('');
  
  return encodedString;
}

// Decoding function
function base27Decode(encodedString) {
  // Define the characters for mapping
  const charMap = "wdbausrhylet ozknqgmfcixvpj";
  
  // Reverse mapping from characters to integers
  const reverseCharMap = {};
  for (let i = 0; i < charMap.length; i++) {
    reverseCharMap[charMap[i]] = i;
  }
  
  // Convert the encoded string to an array of integers
  const integerGroups = [...encodedString].map(char => reverseCharMap[char]);
  
  // Convert integers to trinary and concatenate
  const concatenatedTrinary = integerGroups.map(integer => integer.toString(3).padStart(3, '0')).join('');
  
  // Remove the trailing extra 0s
  const trimmedTrinary = concatenatedTrinary.replace(/0+$/, '');
  
  // Break down into groups of 5 and convert to ASCII values
  const asciiValues = trimmedTrinary.match(/.{5}/g).map(group => parseInt(group, 3));
  
  // Convert ASCII values to characters and concatenate
  const decodedString = String.fromCharCode(...asciiValues);
  
  return decodedString;
}

function fixSpaceTrail(inputString) {
  // Use a regular expression to find trailing spaces and replace them
  return inputString.replace(/( {2,})/g, function(match) {
    // Replace with the number of spaces followed by a single space
    return match.length + ' ';
  });
}

function undoSpaceTrail(inputString) {
  // Use a regular expression to match spaces followed by a number and replace them
  return inputString.replace(/(\d+) /g, function(match, spacesCount) {
    // Replace with the specified number of spaces
    return ' '.repeat(parseInt(spacesCount));
  });
}

function addSpaceToEndIfEndsWithNumber(inputString) {
  // Check if the input string ends with a number
  if (/[\d]$/.test(inputString)) {
    // If it does, add a space to the end and return the new string
    return inputString + ' ';
  } else {
    // If it doesn't end with a number, return the original string
    return inputString;
  }
}

function replaceLeadingSpace(inputString) {
  if (inputString.startsWith(" ")) {
    return "1" + inputString;
  } else {
    return inputString;
  }
}

        function encodeText() {
            const textInput = document.getElementById("text").value;
            const passphraseInput = document.getElementById("passphrase").value;
            const translatedText = replaceLeadingSpace(fixSpaceTrail(shuffleText(salt(base27Encode(shuffleText(compressText(textInput), passphraseInput))), passphraseInput)));
            document.getElementById("output").value = translatedText;
        }

        function decodeText() {
            const textInput = document.getElementById("text").value;
            const passphraseInput = document.getElementById("passphrase").value;
            const decipheredText = decompressText(shuffleText(base27Decode(deSalt(shuffleText(undoSpaceTrail(addSpaceToEndIfEndsWithNumber(textInput)), passphraseInput))), passphraseInput));
            document.getElementById("output").value = decipheredText;
        }
    </script>
</body>
</html>

